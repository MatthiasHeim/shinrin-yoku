<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Forest Bathing 360째 Experience v1.2.2</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://unpkg.com/@vapi-ai/web@1.0.0/dist/vapi-client.js"></script>
    <style>
      #info {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 100;
        display: block;
        color: white;
        background-color: rgba(0,0,0,0.5);
        padding: 10px;
      }
      #title {
        position: absolute;
        top: 50px;
        width: 100%;
        text-align: center;
        z-index: 100;
        display: block;
        color: white;
        font-size: 24px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }
      #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      #toggleSound {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 200;
        padding: 10px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        border: none;
        cursor: pointer;
      }
      #startGuide {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 200;
        padding: 10px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="info">Viewing direction: <span id="direction"></span></div>
    <div id="title">Forest Bathing 360째 Experience v1.2.2</div>
    <div id="videoContainer"></div>
    <button id="toggleSound">Mute</button>
    <button id="startGuide">Start Guided Experience</button>
    <a-scene embedded vr-mode-ui="enabled: false">
      <a-entity id="camera" camera look-controls="reverseMouseDrag: true"></a-entity>
    </a-scene>

    <script>
      let player;
      let camera, directionEl;
      let isSoundOn = true;
      let vapi;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('videoContainer', {
          videoId: '5VDknsNA-Ss',
          playerVars: {
            'autoplay': 1,
            'controls': 0,
            'rel': 0,
            'showinfo': 0,
            'modestbranding': 1,
            'loop': 1,
            'playlist': '5VDknsNA-Ss',
            'enablejsapi': 1
          },
          events: {
            'onReady': onPlayerReady
          }
        });
      }
      function onPlayerReady(event) {
        event.target.unMute();
        event.target.playVideo();
      }

      function initializeViewer() {
        camera = document.getElementById('camera');
        directionEl = document.getElementById('direction');

        if (!camera) {
          console.error('Camera element not found');
          return;
        }

        function updateDirection() {
          const rotation = camera.getAttribute('rotation');
          if (rotation && typeof rotation.y !== 'undefined' && typeof rotation.x !== 'undefined') {
            const yaw = Math.round(rotation.y);
            const pitch = Math.round(rotation.x);
            directionEl.textContent = `Yaw: ${yaw}째, Pitch: ${pitch}째`;
          } else {
            console.warn('Camera rotation not available');
          }
        }

        camera.addEventListener('componentchanged', function(evt) {
          if (evt.detail.name === 'rotation') {
            updateDirection();
          }
        });

        updateDirection();

        document.getElementById('toggleSound').addEventListener('click', function() {
          if (isSoundOn) {
            player.mute();
            this.textContent = 'Unmute';
          } else {
            player.unMute();
            this.textContent = 'Mute';
          }
          isSoundOn = !isSoundOn;
        });

        document.getElementById('startGuide').addEventListener('click', startGuidedExperience);

        // Initialize VAPI with the provided public key
        vapi = new Vapi("b1bdc903-982d-4845-b770-4e5334614c88");
        setupVapiEventListeners();
      }

      function setupVapiEventListeners() {
        vapi.on("call-start", () => {
          console.log("Guided experience has started.");
        });

        vapi.on("call-end", () => {
          console.log("Guided experience has ended.");
        });

        vapi.on("speech-start", () => {
          console.log("Guide is speaking.");
          player.setVolume(30);  // Lower video volume when guide is speaking
        });

        vapi.on("speech-end", () => {
          console.log("Guide has finished speaking.");
          player.setVolume(100);  // Restore video volume
        });

        vapi.on("error", (e) => {
          console.error("VAPI error:", e);
        });
      }

      function startGuidedExperience() {
        vapi.start("17800062-cdea-41c1-a0f9-848e53ac8288");
      }

      document.querySelector('a-scene').addEventListener('loaded', initializeViewer);
    </script>
  </body>
</html>
