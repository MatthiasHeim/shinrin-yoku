<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Forest Bathing 360째 Experience v1.2.6</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://unpkg.com/@vapi-ai/web@1.2.2/dist/vapi-web.js"></script>
    <style>
      #info {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 100;
        display: block;
        color: white;
        background-color: rgba(0,0,0,0.5);
        padding: 10px;
      }
      #title {
        position: absolute;
        top: 50px;
        width: 100%;
        text-align: center;
        z-index: 100;
        display: block;
        color: white;
        font-size: 24px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }
      #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      #toggleSound, #startGuide {
        position: absolute;
        bottom: 20px;
        z-index: 200;
        padding: 10px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        border: none;
        cursor: pointer;
      }
      #toggleSound { left: 20px; }
      #startGuide { right: 20px; }
      #errorMessage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: none;
      }
      #vapiStatus {
        position: absolute;
        top: 100px;
        width: 100%;
        text-align: center;
        color: white;
        background-color: rgba(0,0,0,0.5);
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div id="info">Viewing direction: <span id="direction"></span></div>
    <div id="title">Forest Bathing 360째 Experience v1.2.6</div>
    <div id="vapiStatus">VAPI Status: Loading...</div>
    <div id="videoContainer"></div>
    <button id="toggleSound">Mute</button>
    <button id="startGuide">Start Guided Experience</button>
    <div id="errorMessage"></div>
    <a-scene embedded vr-mode-ui="enabled: false">
      <a-entity id="camera" camera look-controls="reverseMouseDrag: true"></a-entity>
    </a-scene>

    <script>
      let player;
      let camera, directionEl;
      let isSoundOn = true;
      let vapi;

      function showError(message) {
        const errorElement = document.getElementById('errorMessage');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        console.error(message);
      }

      function updateVapiStatus(status) {
        document.getElementById('vapiStatus').textContent = "VAPI Status: " + status;
      }

      function initializeVapi() {
        if (typeof Vapi !== 'undefined') {
          try {
            vapi = new Vapi("b1bdc903-982d-4845-b770-4e5334614c88");
            setupVapiEventListeners();
            updateVapiStatus("Initialized");
            console.log("VAPI initialized successfully");
          } catch (error) {
            updateVapiStatus("Failed to Initialize");
            showError("Error initializing VAPI: " + error.message);
          }
        } else {
          updateVapiStatus("Failed to Load");
          showError("VAPI library not loaded. Guided experience unavailable.");
        }
      }

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('videoContainer', {
          videoId: '5VDknsNA-Ss',
          playerVars: {
            'autoplay': 1,
            'controls': 0,
            'rel': 0,
            'showinfo': 0,
            'modestbranding': 1,
            'loop': 1,
            'playlist': '5VDknsNA-Ss',
            'enablejsapi': 1
          },
          events: {
            'onReady': onPlayerReady,
            'onError': onPlayerError
          }
        });
      }

      function onPlayerReady(event) {
        event.target.unMute();
        event.target.playVideo();
      }

      function onPlayerError(event) {
        showError("YouTube player error: " + event.data);
      }

      function initializeViewer() {
        camera = document.getElementById('camera');
        directionEl = document.getElementById('direction');

        if (!camera) {
          showError('Camera element not found');
          return;
        }

        function updateDirection() {
          const rotation = camera.getAttribute('rotation');
          if (rotation && typeof rotation.y !== 'undefined' && typeof rotation.x !== 'undefined') {
            const yaw = Math.round(rotation.y);
            const pitch = Math.round(rotation.x);
            directionEl.textContent = `Yaw: ${yaw}째, Pitch: ${pitch}째`;
          } else {
            console.warn('Camera rotation not available');
          }
        }

        camera.addEventListener('componentchanged', function(evt) {
          if (evt.detail.name === 'rotation') {
            updateDirection();
          }
        });

        updateDirection();

        document.getElementById('toggleSound').addEventListener('click', function() {
          if (player && player.mute && player.unMute) {
            if (isSoundOn) {
              player.mute();
              this.textContent = 'Unmute';
            } else {
              player.unMute();
              this.textContent = 'Mute';
            }
            isSoundOn = !isSoundOn;
          } else {
            showError("YouTube player not ready");
          }
        });

        document.getElementById('startGuide').addEventListener('click', startGuidedExperience);

        // Initialize VAPI
        initializeVapi();
      }

      function setupVapiEventListeners() {
        vapi.on("call-start", () => {
          console.log("Guided experience has started.");
          updateVapiStatus("Call Started");
        });

        vapi.on("call-end", () => {
          console.log("Guided experience has ended.");
          updateVapiStatus("Call Ended");
        });

        vapi.on("speech-start", () => {
          console.log("Guide is speaking.");
          if (player && player.setVolume) {
            player.setVolume(30);  // Lower video volume when guide is speaking
          }
        });

        vapi.on("speech-end", () => {
          console.log("Guide has finished speaking.");
          if (player && player.setVolume) {
            player.setVolume(100);  // Restore video volume
          }
        });

        vapi.on("error", (e) => {
          showError("VAPI error: " + e);
          updateVapiStatus("Error");
        });
      }

      function startGuidedExperience() {
        if (vapi && vapi.start) {
          try {
            vapi.start("17800062-cdea-41c1-a0f9-848e53ac8288");
            updateVapiStatus("Starting Call");
          } catch (error) {
            showError("Error starting guided experience: " + error.message);
            updateVapiStatus("Start Failed");
          }
        } else {
          showError("VAPI not initialized. Cannot start guided experience.");
          updateVapiStatus("Not Initialized");
        }
      }

      document.querySelector('a-scene').addEventListener('loaded', initializeViewer);
    </script>
  </body>
</html>
